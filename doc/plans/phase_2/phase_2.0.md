# Фаза 2: Профессиональная админка и Markdown с подсветкой кода

## Общая цель

Трансформировать блог из базового MVP в визуально привлекательное приложение с профессиональной админ-панелью и полноценной поддержкой Markdown-контента с подсветкой синтаксиса кода и диаграмм.

## Результат фазы

Работающее приложение с:

- **Красивой админкой** — django-unfold вместо стандартной админки
- **Полной русификацией** — модели, поля, админ-интерфейс на русском
- **Markdown поддержкой** — автоматическая конвертация Markdown → HTML при сохранении
- **Подсветкой кода** — Highlight.js для синтаксиса в code blocks
- **Диаграммами** — Mermaid.js для рендеринга диаграмм прямо в постах
- **Профессиональными стилями** — кастомный CSS для code blocks и контента

## Философия фазы

**"Визуально эффектный функционал для YouTube-сериала"**

- ✅ Unfold админка — **впечатляющая** замена стандартного интерфейса
- ✅ Markdown → HTML — **автоматизация** без лишних действий
- ✅ Highlight.js — **красивый код** в статьях о программировании
- ✅ Mermaid — **диаграммы** через простой синтаксис
- ✅ Без фронтенд-фреймворков — всё через **CDN** (простота и скорость)

**Не делаем (оставляем на будущее):**

- ❌ Markdown preview в админке (слишком сложно для этой фазы)
- ❌ Drag-and-drop загрузка изображений
- ❌ WYSIWYG редактор (философия проекта — Markdown)
- ❌ Тесты (выделим отдельную фазу для pytest)

## Подфазы

### Базовая инфраструктура (2.1-2.2)

#### [Фаза 2.1](phase_2.1.md): Установка и настройка Unfold админки

Установка django-unfold, замена стандартной админки, базовая конфигурация (цвета, логотип, навигация).

#### [Фаза 2.2](phase_2.2.md): Полная русификация приложения

Перевод админки на русский, verbose_name для всех моделей и полей, русификация названий приложений.

### Markdown и Frontend (2.3-2.4)

#### [Фаза 2.3](phase_2.3.md): Markdown → HTML конвертация

Установка python-markdown, добавление поля `content_html`, автоматическая конвертация при сохранении, миграция существующих постов.

#### [Фаза 2.4](phase_2.4.md): Подсветка синтаксиса и диаграммы

Подключение Highlight.js и Mermaid.js через CDN, настройка тем, инициализация, стилизация code blocks и диаграмм.

## Технологический стек

### Новые зависимости

- **django-unfold** — современная админка для Django
- **markdown** — парсер Markdown в HTML
- **pymdown-extensions** — расширения для Markdown (подсветка синтаксиса, таблицы)
- **pygments** — подсветка синтаксиса на бэкенде (для Markdown)

### Frontend библиотеки (CDN)

- **Highlight.js** — подсветка синтаксиса кода на фронтенде
- **Mermaid.js** — рендеринг диаграмм из Markdown

### Сохраняем из Phase 1

- Django 6.0 (beta)
- Bootstrap 5.3
- django-components
- HTMX 2.0
- django-htmx

## Архитектура решения

### Markdown → HTML Pipeline

```
Админка (Markdown)
       ↓
  Post.save()
       ↓
  markdown.markdown()
       ↓
  content_html (DB)
       ↓
  Template ({{ content_html|safe }})
       ↓
  Highlight.js (инициализация)
       ↓
  Mermaid.js (рендеринг диаграмм)
```

**Преимущества:**

- ✅ Конвертация один раз (при сохранении)
- ✅ Быстрый рендеринг (HTML уже готов)
- ✅ Независимость от Markdown библиотеки на фронте
- ✅ SEO-friendly (HTML в базе)

**Недостатки:**

- ⚠️ Дополнительное поле в БД
- ⚠️ Нужна миграция при смене Markdown движка

### Unfold админка — настройки

**Кастомизация под стиль проекта:**

- Цвета: темная тема + желтые акценты (соответствует style_guide)
- Иконки: Tabler Icons (встроенные в Unfold)
- Навигация: сворачиваемая боковая панель
- Виджеты: Monaco Editor для Markdown (опционально)

## Безопасность

### XSS защита

**Проблема:** Markdown может содержать опасный HTML/JavaScript.

**Решение:**

1. **Доверяем админам** — на данном этапе админка доступна только владельцу
2. **Ограничиваем HTML теги** — markdown с `safe_mode` (опционально)
3. **Санитизация в будущем** — когда появятся пользовательские посты (Phase 3+)

### CSRF защита

- ✅ Уже настроена в Phase 1.8 (HTMX + meta теги)
- ✅ django-unfold использует стандартную Django CSRF защиту

## Совместимость с Phase 1

### Что остается без изменений

- ✅ Все URL паттерны (`/`, `/post/<pk>/`, `/about/`)
- ✅ Все views (только минимальные правки)
- ✅ django-components (Button, PostCard, Alert, Paginator)
- ✅ HTMX функционал (поиск, пагинация)
- ✅ Bootstrap 5 стили

### Что изменится

- ✏️ `Post` модель — добавится поле `content_html`
- ✏️ `post_detail.html` — заменим `{{ post.content|linebreaks }}` на `{{ post.content_html|safe }}`
- ✏️ `base.html` — добавим CDN для Highlight.js и Mermaid.js
- ✏️ `style.css` — добавим стили для code blocks и диаграмм
- ✏️ `settings.py` — замена `django.contrib.admin` на `unfold.admin`

## Миграция данных

### Существующие посты

**Проблема:** В БД 15 постов с plain text контентом (из management команды `create_posts`).

**Решение:**

1. Добавить миграцию с новым полем `content_html`
2. Создать data migration для конвертации существующих постов:
   - Прочитать `content`
   - Конвертировать через `markdown.markdown()`
   - Сохранить в `content_html`
3. Альтернатива: пересохранить все посты через админку (быстрее для 15 постов)

## Документация

### Существующие исследования

- [Python Markdown Integration](../../researches/report_5/README.md) — готовое исследование из Phase 1
- [Django Components](../../researches/report_3/README.md) — для понимания архитектуры
- [HTMX Integration](../../researches/report_4/README.md) — совместимость с динамикой

### Новые ресурсы

- django-unfold документация: <https://unfoldadmin.com/>
- Highlight.js: <https://highlightjs.org/>
- Mermaid.js: <https://mermaid.js.org/>
- Python Markdown: <https://python-markdown.github.io/>

## Следующая фаза

**Фаза 3:** Расширенные возможности блога

Варианты:

- **3.0:** Категории и теги с HTMX-фильтрацией
- **3.1:** Комментарии в реальном времени
- **3.2:** Система пользователей и авторов
- **3.3:** Полнотекстовый поиск (PostgreSQL FTS)

## Чеклист готовности к Phase 2

### Перед началом убедитесь

- [x] Phase 1.8 полностью завершена
- [x] Все HTMX функции работают (поиск, пагинация)
- [x] В БД есть тестовые посты (минимум 5-10 для проверки)
- [x] Виртуальное окружение активно
- [x] Poetry настроен и готов к установке новых зависимостей
- [ ] Создан бэкап БД (на случай проблем с миграцией)
- [ ] Прочитана документация Unfold (базовое понимание)

## Время выполнения

**Оценка:** 2-3 дня чистого времени

- Phase 2.1 (Unfold) — 3-4 часа
- Phase 2.2 (Русификация) — 1-2 часа
- Phase 2.3 (Markdown) — 4-5 часов
- Phase 2.4 (Highlight.js + Mermaid) — 2-3 часа

**Для YouTube-контента:** ~3-4 видео по 15-20 минут каждое.

## Риски и их митигация

### Риск 1: Конфликт Unfold с django-components

**Вероятность:** Низкая  
**Решение:** Unfold работает с admin, components с frontend — разные слои.

### Риск 2: Проблемы с Markdown конвертацией

**Вероятность:** Средняя (encoding, специальные символы)  
**Решение:** Тестировать на разных примерах, использовать `safe_mode`.

### Риск 3: Производительность Markdown парсинга

**Вероятность:** Низкая (конвертация при сохранении, не при каждом запросе)  
**Решение:** Кэширование уже реализовано через поле `content_html`.

### Риск 4: XSS через Markdown

**Вероятность:** Средняя (если разрешить опасный HTML)  
**Решение:** Ограничить теги, добавить bleach санитизацию позже.

## Успех фазы измеряется по

- ✅ Unfold админка полностью заменила стандартную
- ✅ Все поля и модели на русском языке
- ✅ Markdown автоматически конвертируется в HTML при сохранении
- ✅ Code blocks с подсветкой синтаксиса отображаются корректно
- ✅ Mermaid диаграммы рендерятся в постах
- ✅ Существующие посты мигрированы без потерь
- ✅ HTMX функционал работает без изменений
- ✅ Стили code blocks соответствуют дизайну проекта
