# Фаза 3: Медиа-система и контент-управление

## Общая цель

Трансформировать блог из простого текстового приложения в полноценную контент-платформу с поддержкой медиа-файлов (изображения, видео, аудио), автоматическим импортом из Obsidian, категориями, тегами и расширенными метаданными постов.

## Результат фазы

Работающее приложение с:

- **Медиа-системой** — модель PostMedia для изображений, видео, аудио
- **Категориями и тегами** — иерархическая организация контента
- **Расширенной моделью Post** — автор, рейтинг, обложка, описание, статусы
- **Obsidian-импортом** — ZIP-архивы с Markdown и медиа загружаются автоматически
- **Препроцессором ссылок** — `![[image.png]]` → рабочие URL без ручной правки
- **MEDIA настройками** — полная интеграция файлового хранилища
- **Управлением рейтингами** — модель UserPostRating с денормализацией
- **Формой создания поста** — кастомный UI в Unfold админке
- **Tom Select интеграцией** — современные селекторы для тегов
- **S3-готовностью** — архитектура для миграции на объектное хранилище

## Философия фазы

**"Post-Centric Media + Zero Manual Work"**

- ✅ Медиа привязаны к постам — изоляция ресурсов, чистота структуры
- ✅ Оригинальные имена файлов — `original_filename` для матчинга при импорте
- ✅ Автоматический маппинг — препроцессор переписывает ссылки сам
- ✅ ZIP → готовый пост — загрузил архив из Obsidian, всё работает
- ✅ Storage API — код готов к S3, работает с локальными файлами
- ✅ Поэтапная реализация — каждая подфаза = логический результат + коммит

**Не делаем (оставляем на Phase 4+):**

- ❌ S3 интеграция (пока локальное хранилище)
- ❌ Оптимизация изображений (thumbnails, responsive)
- ❌ Фоновые задачи очистки "сирот"
- ❌ API endpoints для загрузки (Phase 4)
- ❌ Ghost Draft UI (Phase 5)
- ❌ LMS функционал (Phase 6+)

## Подфазы

### Базовая инфраструктура (3.1-3.3)

#### [Фаза 3.1](phase_3.1.md): MEDIA настройки и URL конфигурация

Настройка `MEDIA_URL`, `MEDIA_ROOT` в settings.py, добавление URL patterns для dev-режима, создание структуры папок `media/posts/`.

**Результат:** Django готов принимать и раздавать файлы.

**Для архитектурного сериала:** Настройка файлового хранилища Django, разница STATIC vs MEDIA, подготовка к S3.

#### [Фаза 3.2](phase_3.2.md): Модели Category и Tag

Создание моделей `Category` (с полями name, slug, description, default_cover) и `Tag` (name, slug), связи с Post через ManyToMany, миграции.

**Результат:** Категории и теги готовы к использованию в админке.

**Для архитектурного сериала:** Проектирование таксономии контента, ForeignKey vs ManyToMany, prepopulated_fields для slug.

#### [Фаза 3.3](phase_3.3.md): Расширение модели Post

Добавление полей: `author` (FK User), `excerpt`, `cover` (FK PostMedia, null=True), `status` (choices), `access_level` (choices), `views_count`, `rating`, `category` (FK), `tags` (M2M). Миграция с дефолтными значениями.

**Результат:** Post готов к полноценному контент-управлению и будущему LMS.

**Для архитектурного сериала:** Эволюция модели данных, добавление полей с сохранением обратной совместимости, choices для статусов.

### Медиа-система (3.4-3.6)

#### [Фаза 3.4](phase_3.4.md): Модель PostMedia

Создание модели `PostMedia` (post FK, file FileField, original_filename, file_slug, media_type, created_at), функция `upload_to='posts/{slug}/'`, авто-определение media_type по расширению в `save()`.

**Результат:** Можем загружать и хранить файлы, привязанные к постам.

**Для архитектурного сериала:** Post-Centric Media архитектура, FileField vs ImageField, upload_to как функция, auto_now vs auto_now_add.

#### [Фаза 3.5](phase_3.5.md): Админка для PostMedia (TabularInline)

Добавление `PostMediaInline` в `PostAdmin`, отображение preview изображений, readonly поле с готовой Markdown-ссылкой для копирования, кнопка "Скачать".

**Результат:** Ручной workflow — загрузили файлы, скопировали ссылки, вставили в Markdown.

**Для архитектурного сериала:** TabularInline и StackedInline, кастомные методы для preview, readonly_fields для вычисляемых значений.

#### [Фаза 3.6](phase_3.6.md): Админка для Category и Tag

Создание `CategoryAdmin` (list_display, prepopulated_fields, preview обложки) и `TagAdmin` (простой список), интеграция в PostAdmin (filter_horizontal для тегов, autocomplete для категории).

**Результат:** Удобное управление категориями и тегами в админке.

**Для архитектурного сериала:** Админка для справочников, filter_horizontal для ManyToMany, autocomplete_fields для оптимизации.

### Препроцессор Markdown (3.7-3.9)

#### [Фаза 3.7](phase_3.7.md): Сервис MarkdownMediaPreprocessor

Создание `blog/services/markdown_media_preprocessor.py` с классом, который парсит Markdown, находит `![[filename]]` и `![](filename)`, ищет PostMedia по `original_filename`, заменяет на `/media/posts/{slug}/{filename}`.

**Результат:** Базовая логика обработки локальных ссылок в Markdown.

**Для архитектурного сериала:** Препроцессоры vs постпроцессоры, regex для парсинга Markdown, работа с путями через pathlib.

#### [Фаза 3.8](phase_3.8.md): Интеграция препроцессора в Post.save()

Модификация `convert_markdown_to_html()` — добавить вызов препроцессора ДО `markdown.markdown()`, передача объекта Post для доступа к связанным PostMedia.

**Результат:** Ссылки `![[image.png]]` автоматически резолвятся при сохранении поста.

**Для архитектурного сериала:** Интеграция препроцессора в существующий pipeline, модификация convert_markdown_to_html без breaking changes.

#### [Фаза 3.9](phase_3.9.md): Поддержка Obsidian wikilinks

Добавление метода `convert_wikilinks()` в препроцессор: `![[file.png]]` → `![](file.png)`, обработка вариантов с alt-текстом `![[file.png|alt]]`.

**Результат:** Полная совместимость с Obsidian-нотацией ссылок.

**Для архитектурного сериала:** Obsidian wikilinks синтаксис, конвертация в стандартный Markdown, обработка edge cases.

### ZIP-импорт (3.10-3.12)

#### [Фаза 3.10](phase_3.10.md): Утилита распаковки ZIP-архивов

Создание `blog/services/archive_handler.py` с функциями: `extract_zip()` (распаковка в temp), `find_markdown_file()`, `find_media_files()`, `cleanup_temp()`.

**Результат:** Базовая логика работы с ZIP-архивами.

**Для архитектурного сериала:** Работа с zipfile, tempfile для временных директорий, безопасная распаковка архивов.

#### [Фаза 3.11](phase_3.11.md): Сервис импорта постов из ZIP

Создание `blog/services/post_importer.py` с классом `PostImporter`: метод `import_from_zip(zip_path, title)` — распаковка, создание Post, загрузка медиа; метод `create_media_mapping()` — словарь `{original_filename: PostMedia}`; интеграция с препроцессором.

**Результат:** Программная логика импорта готова, можно вызывать из кода.

**Для архитектурного сериала:** Сервисный слой в Django, транзакционность импорта, обработка ошибок.

#### [Фаза 3.12](phase_3.12.md): Management command import_post

Создание management command с опциями `--category`, `--tags`, `--published`, `--dry-run` для импорта ZIP-архивов и папок.

**Результат:** Можно импортировать посты из командной строки.

**Для архитектурного сериала:** Создание management commands, argparse в Django, dry-run режим для безопасности.

### Рейтинги и метрики (3.13-3.14)

#### [Фаза 3.13](phase_3.13.md): Модель UserPostRating

Создание модели `UserPostRating` (user FK, post FK, rating IntegerField 1-5, created_at), `unique_together=['user', 'post']`, миграция.

**Результат:** Пользователи могут ставить оценки постам (через админку пока).

**Для архитектурного сериала:** Модели рейтингов, validators для ограничения значений, unique_together для защиты от дублей.

#### [Фаза 3.14](phase_3.14.md): Денормализация рейтинга в Post

Добавление Django signal `post_save` для UserPostRating, функция пересчёта среднего рейтинга и обновления `Post.rating`.

**Результат:** Поле `Post.rating` автоматически обновляется при новых оценках.

**Для архитектурного сериала:** Django signals, денормализация данных для оптимизации, aggregate() для вычислений.

### Утилиты и доработки (3.15-3.17)

#### [Фаза 3.15](phase_3.15.md): Management command regenerate_html

Создание команды для пересоздания `content_html` всех постов с опциями фильтрации по slug, категории, дате.

**Результат:** При добавлении нового процессора можно обновить все посты одной командой.

**Для архитектурного сериала:** Batch-операции в Django, bulk_update для оптимизации, прогресс-бар для длительных операций.

#### [Фаза 3.16](phase_3.16.md): Unfold action "Пересоздать HTML"

Добавление кастомного action в `PostAdmin` для пере-рендера выбранных постов через админку, прогресс-бар (опционально), сообщение об успехе.

**Результат:** Админ может обновить посты через UI без терминала.

**Для архитектурного сериала:** Кастомные actions в Django Admin, работа с QuerySet, messages framework для уведомлений.

#### [Фаза 3.17](phase_3.17.md): Обработка внешних ссылок в препроцессоре

Модификация препроцессора: игнорировать ссылки с `http://` и `https://`, обработка относительных путей `./image.png` и `../image.png`, обработка вложенных папок Obsidian `attachments/subfolder/file.png`.

**Результат:** Препроцессор корректно различает локальные и внешние ресурсы.

**Для архитектурного сериала:** URL parsing, определение типа ссылки, обработка edge cases в путях.

### Админка и UI (3.18-3.20)

#### [Фаза 3.18](phase_3.18.md): Обновление PostAdmin — расширенные фильтры

Добавление фильтров по: `category`, `tags`, `status`, `access_level`, `author`, `created_at` (date hierarchy), настройка `list_filter` и `search_fields`.

**Результат:** Удобная навигация по постам в админке.

**Для архитектурного сериала:** Фильтры Django Admin, date_hierarchy для временных данных, search_fields для полнотекстового поиска.

#### [Фаза 3.19](phase_3.19.md): Fieldsets и organization в PostAdmin

Разбивка формы Post на логические блоки: "Основное", "Контент", "Медиа", "Метаданные", "SEO", "Публикация", использование `collapse` для длинных полей.

**Результат:** Чистая и структурированная форма редактирования поста.

**Для архитектурного сериала:** Fieldsets в Django Admin, classes для collapse, группировка полей по смыслу.

#### [Фаза 3.20](phase_3.20.md): Отображение cover и excerpt в списке постов

Добавление методов `display_cover()` (thumbnail в list_display) и `display_excerpt()` (первые 100 символов), кастомная сортировка по рейтингу.

**Результат:** Визуально богатый список постов в админке.

**Для архитектурного сериала:** Демонстрация богатых карточек постов в list_display, кастомные методы для отображения, сортировка по рейтингу.

### Форма создания поста (3.21-3.22)

#### [Фаза 3.21](phase_3.21.md): Кастомная форма создания поста в Unfold

Создание отдельного view и формы для создания поста с возможностью загрузки медиа, интеграция в Unfold меню через кастомный URL, HTMX для динамической загрузки файлов.

**Результат:** Удобная форма создания поста с drag-and-drop загрузкой медиа прямо в админке.

**Для архитектурного сериала:** Кастомизация Unfold админки, создание собственных маршрутов, интеграция HTMX в админ-панель.

#### [Фаза 3.22](phase_3.22.md): Обновление templates для категорий и тегов

Модификация `post_detail.html` — отображение категории и тегов, ссылки на страницы фильтрации (пока заглушки), отображение cover и excerpt в `post_card.html`.

**Результат:** Фронтенд отображает новые данные постов.

**Для архитектурного сериала:** Обновление template-логики, работа с новыми полями модели, условный рендеринг cover.

### Tom Select интеграция (3.23-3.25)

#### [Фаза 3.23](phase_3.23.md): Установка Tom Select и django-tomselect

Добавление зависимостей `django-tomselect`, проверка совместимости с Django 6, базовая конфигурация в settings.py, подключение статики Tom Select.

**Результат:** Tom Select готов к использованию в проекте.

**Для архитектурного сериала:** Обзор Tom Select как современной альтернативы select2, особенности интеграции с Django 6.

#### [Фаза 3.24](phase_3.24.md): Интеграция Tom Select для тегов

Замена стандартного виджета тегов на Tom Select в PostAdmin, настройка `create=True` для создания тегов на лету, стилизация под Unfold тему.

**Результат:** Красивый и удобный selector тегов с возможностью создания новых.

**Для архитектурного сериала:** Tom Select для ManyToMany полей, кастомизация виджетов Django-форм.

#### [Фаза 3.25](phase_3.25.md): Tom Select для категорий и других селекторов

Применение Tom Select к ForeignKey полям (category, author), настройка автокомплита, единый стиль всех селекторов в админке.

**Результат:** Все селекты в админке используют Tom Select с единообразным UI.

**Для архитектурного сериала:** Унификация UI админки, работа с ForeignKey через Tom Select.

## Технологический стек

### Новые зависимости Phase 3

- **django-tomselect** — современный виджет для селекторов и тегов
- **Проверка совместимости с Django 6** — требуется тестирование

### Встроенные модули Python (без установки)

- `zipfile` — распаковка ZIP-архивов
- `pathlib` — работа с путями
- `mimetypes` — определение типа файла
- `tempfile` — временные директории
- `re` — регулярные выражения для парсинга ссылок

### Опциональные зависимости (Phase 4+)

- **Pillow** — для извлечения `width`/`height` изображений (не обязательно для Phase 3)
- **django-storages** — для S3 интеграции (Phase 4)
- **boto3** — AWS SDK для S3 (Phase 4)

### Сохраняем из Phase 2

- Django 6.0 beta
- django-unfold
- markdown + pymdown-extensions
- beautifulsoup4 (процессоры)
- Bootstrap 5.3
- django-components
- HTMX 2.0
- Highlight.js + Mermaid.js

## Архитектура решения

### Pipeline обработки контента (обновлённый)

```
Админка / ZIP-импорт
       ↓
  PostMedia создание (оригинальные файлы)
       ↓
  Mapping: {original_filename: file_slug}
       ↓
  MarkdownMediaPreprocessor
    - convert_wikilinks()
    - resolve_local_links()
    - замена на /media/posts/{slug}/...
       ↓
  markdown.markdown()
       ↓
  BeautifulSoup Processors
    - TableProcessor
    - ImageProcessor (Bootstrap классы)
    - BlockquoteProcessor
    - CodeProcessor
       ↓
  content_html (сохранение в БД)
```

### Структура хранения

```
media/
└── posts/
    ├── moya-statya-pro-django/
    │   ├── screenshot1.png
    │   ├── diagram.svg
    │   └── demo.mp4
    └── drugaya-statya/
        ├── screenshot1.png  # НЕ конфликтует!
        └── photo.jpg

categories/
└── default_covers/
    ├── python.jpg
    └── django.jpg
```

### Формат ссылок

| Obsidian (на входе) | В базе (после препроцессора) | HTML (после рендера) |
|---------------------|------------------------------|----------------------|
| `![[image.png]]` | `![](/media/posts/my-post/image.png)` | `<img src="/media/posts/my-post/image.png" class="img-fluid" loading="lazy">` |
| `![alt](image.png)` | `![alt](/media/posts/my-post/image.png)` | `<img src="..." alt="alt" ...>` |
| `![](https://...)` | Без изменений | Без изменений |
| `![[attachments/img.png]]` | `![](/media/posts/my-post/img.png)` | `<img src="..." ...>` |

**Ключевой принцип:** В базе хранятся относительные пути `/media/posts/{slug}/...`, которые работают и с локальными файлами, и с S3 (когда добавим).

## Модели данных

### Новые модели Phase 3

**Post (расширенная):**

- Существующие поля сохраняются
- Добавляются: author, excerpt, cover, category, tags
- Статусы: draft, review, published, archived
- Уровни доступа: free, member, paid
- Метрики: views_count, rating

**PostMedia:**

- Связь с Post через ForeignKey
- Поля: file, original_filename, file_slug, media_type
- unique_together для post + original_filename

**Category:**

- Поля: name, slug, description, default_cover
- Связь с Post через ForeignKey

**Tag:**

- Поля: name, slug
- Связь с Post через ManyToMany

**UserPostRating:**

- Связи: user, post
- Поле rating (1-5)
- unique_together для защиты от дублей

## Безопасность

### Валидация ZIP-архивов

**Риски:**

- Zip bomb (архив 10 GB после распаковки)
- Path traversal (`../../etc/passwd`)
- Исполняемые файлы

**Защита:**

1. Проверка размера до распаковки (`max_size=100MB`)
2. Блокировка путей с `..` и абсолютных путей
3. Whitelist расширений: `.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.mp4`, `.webm`, `.mp3`, `.wav`, `.pdf`, `.md`
4. Распаковка в изолированную temp-директорию
5. Cleanup после обработки

### XSS через Markdown

**Текущее состояние:** Доверяем админам (только суперпользователь загружает контент).

**Phase 4 (когда появятся пользовательские посты):**

- Санитизация HTML через `bleach`
- Whitelist разрешённых тегов
- Удаление `<script>`, `onclick`, `onerror` и т.д.

## Совместимость с Phase 2

### Что остаётся без изменений

- ✅ Все URL паттерны
- ✅ Все views (минимальные правки для новых полей)
- ✅ Все components (PostCard получит новые пропсы)
- ✅ Вся система процессоров HTML
- ✅ Markdown → HTML конвертация (расширяется препроцессором)

### Что изменится

- ✏️ `Post` модель — добавятся новые поля
- ✏️ `convert_markdown_to_html()` — добавится вызов препроцессора
- ✏️ Templates — отображение категории, тегов, обложки
- ✏️ `settings.py` — настройки MEDIA
- ✏️ `urls.py` — URL для медиа-файлов
- ✏️ Admin — множество улучшений

### Тестовые данные

**Существующие посты** создаются через management command `create_posts` и не требуют миграции. При изменении модели Post просто пересоздаём тестовые данные командой.

## Риски и митигация

### Риск 1: Битые ссылки после импорта

**Вероятность:** Средняя  
**Причина:** Сложные структуры папок в Obsidian  
**Решение:**

- Поддержка относительных путей `./`, `../`
- Поиск файлов рекурсивно в архиве
- Dry-run режим для проверки перед импортом

### Риск 2: Производительность препроцессора

**Вероятность:** Низкая (обработка при сохранении, не при запросе)  
**Причина:** Regex парсинг может быть медленным для больших статей  
**Решение:**

- Оптимизация регулярных выражений
- Кеширование списка PostMedia для поста
- Профилирование на реальных данных

### Риск 3: Заполнение диска медиа-файлами

**Вероятность:** Средняя (если много видео)  
**Причина:** Нет ограничений на размер файлов  
**Решение:**

- `MAX_UPLOAD_SIZE = 100MB` в валидации
- Management command для очистки неиспользуемых файлов (Phase 4)
- Мониторинг размера `media/` директории

### Риск 4: Конфликты slug при автогенерации

**Вероятность:** Низкая  
**Причина:** Несколько файлов с одинаковым именем в одном посте  
**Решение:**

- `unique_together = ['post', 'original_filename']`
- Для `file_slug` добавлять UUID-суффикс при коллизии

## Успех фазы измеряется по

- ✅ Модель PostMedia создана и работает
- ✅ MEDIA_URL / MEDIA_ROOT настроены
- ✅ Category и Tag интегрированы в админку
- ✅ Post расширен всеми полями из спецификации
- ✅ ZIP-архив из Obsidian импортируется одной командой
- ✅ Ссылки `![[image.png]]` автоматически работают в постах
- ✅ Препроцессор корректно обрабатывает локальные и внешние ссылки
- ✅ UserPostRating работает с автоматическим пересчётом
- ✅ `regenerate_html` обновляет все посты
- ✅ Админка показывает категории, теги, обложки
- ✅ Кастомная форма создания поста работает
- ✅ Tom Select интегрирован для тегов и селекторов
- ✅ Нет битых ссылок на медиа-файлы

## Следующая фаза

**Фаза 4:** S3-интеграция и оптимизация медиа

Варианты:

- **4.1:** Интеграция Timeweb S3 / AWS S3
- **4.2:** Генерация thumbnails (Pillow)
- **4.3:** Responsive images (`srcset`, `sizes`)
- **4.4:** Видео-плееры (кастомные компоненты)
- **4.5:** API endpoints для загрузки медиа
- **4.6:** Фоновые задачи очистки (Celery / Django Q)

## Чеклист готовности к Phase 3

### Перед началом убедитесь

- [x] Phase 2 полностью завершена
- [x] Все процессоры работают (Table, Image, Blockquote, Code)
- [x] Unfold админка настроена
- [x] Виртуальное окружение активно
- [ ] Подготовлено 3-5 тестовых ZIP-архивов из Obsidian с реальными статьями
- [ ] Изучена техническая спецификация Phase 3

## Время выполнения

**Оценка:** 6-8 дней чистого времени

- Phase 3.1-3.3 (Инфраструктура) — 4-5 часов
- Phase 3.4-3.6 (Медиа-система) — 6-8 часов
- Phase 3.7-3.9 (Препроцессор) — 8-10 часов
- Phase 3.10-3.12 (ZIP-импорт) — 10-12 часов
- Phase 3.13-3.14 (Рейтинги) — 3-4 часа
- Phase 3.15-3.17 (Утилиты) — 4-5 часов
- Phase 3.18-3.20 (Админка) — 5-6 часов
- Phase 3.21-3.22 (Форма создания + Templates) — 6-8 часов
- Phase 3.23-3.25 (Tom Select) — 4-5 часов

**Для YouTube-контента:** ~10-12 видео по 15-25 минут каждое.

**Рекомендация:** Делать по 2-3 подфазы в день, тестировать на реальных Obsidian-заметках.
