# Фаза 4.11: Гибридный поиск (RRF)

## Цель

Объединить семантический и лексический поиск через алгоритм Reciprocal Rank Fusion.

---

## Контекст

Семантический и лексический поиск дополняют друг друга:
- **Семантический:** "как подключиться к базе" → находит статьи про DATABASES
- **Лексический:** "DATABASES" → находит точное упоминание термина

Проблема объединения: шкалы скоров разные (косинусное расстояние vs tf-idf). Простое сложение не работает.

**Reciprocal Rank Fusion (RRF)** решает это элегантно:
- Работает с рангами (позициями в списке), а не с абсолютными скорами
- Формула: `RRF_score = 1/(k + rank_vec) + 1/(k + rank_fts)`
- Константа сглаживания `k = 60` (стандартное значение)
- Результаты, релевантные в обоих методах, получают высший ранг

**Преимущества RRF:**
- Не требует калибровки весов
- Устойчив к выбросам
- Штрафует результаты из одного метода

**Философия:** Консенсус двух методов лучше любого одного.

**Документация:**
- [Технический отчёт: Chonkie, PostgreSQL, pgvector](../researches/report_6/Технический%20отчет_%20Chonkie,%20Postgresql,%20pgvector.md) — раздел 5.3 "Алгоритм гибридного поиска: RRF"
- [ИИ поиск на базе смыслов — концепция](../researches/report_6/ИИ%20поиск%20на%20базе%20смыслов%20-%20концепция.md) — "Reciprocal Rank Fusion"

---

## Задачи

### Функция гибридного поиска

- [ ] Добавить в `blog/services/search_service.py` функцию `hybrid_search(query: str, limit: int = 10) -> list[SearchResult]`
- [ ] Функция вызывает `semantic_search` и `lexical_search` параллельно
- [ ] Объединяет результаты через RRF

### Реализация RRF

- [ ] Получить топ-60 результатов из семантического поиска (с рангами 1-60)
- [ ] Получить топ-60 результатов из лексического поиска (с рангами 1-60)
- [ ] Для каждого уникального чанка вычислить RRF-скор
- [ ] Формула: `rrf_score = 1.0 / (60 + rank_vec) + 1.0 / (60 + rank_fts)`
- [ ] Если чанк есть только в одном списке, второе слагаемое = 0
- [ ] Отсортировать по убыванию rrf_score

### Оптимизация через SQL

- [ ] Рассмотреть выполнение RRF целиком в PostgreSQL через CTE
- [ ] Это избавит от передачи 120 записей в Python
- [ ] Пример: два CTE (semantic, lexical) + FULL OUTER JOIN + формула RRF

### Параметры настройки

- [ ] Константа `k = 60` — вынести в settings
- [ ] Количество кандидатов из каждого метода (по умолчанию 60)
- [ ] Финальный лимит результатов (по умолчанию 10)

### Обработка крайних случаев

- [ ] Пустой запрос — вернуть пустой список
- [ ] Нет результатов в одном из методов — использовать только второй
- [ ] Все результаты с нулевым скором — проверить индексы

---

## Тестирование

- [ ] Запрос со смысловым содержанием: "как настроить подключение"
- [ ] Запрос с точным термином: "DATABASES"
- [ ] Смешанный запрос: "настройка DATABASES"
- [ ] Сравнить результаты hybrid vs semantic vs lexical
- [ ] Убедиться, что гибрид даёт лучшие результаты

---

## Коммит

```
phase 4.11 feat: Гибридный поиск (RRF)
- Добавлена функция hybrid_search в search_service.py
- Реализован алгоритм Reciprocal Rank Fusion
- Объединение семантического и лексического поиска
- Оптимизация через SQL CTE
```
