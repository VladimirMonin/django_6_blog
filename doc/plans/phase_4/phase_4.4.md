# Фаза 4.4: Связь Post → TextChunk

## Цель

Настроить связь между постами и чанками с автоматическим триггером индексации.

---

## Контекст

Модель `TextChunk` уже содержит FK на `Post`, но нужна логика автоматической переиндексации при изменении поста. Django Signals (`post_save`, `post_delete`) позволяют реагировать на события модели без изменения её кода.

При сохранении поста система должна:

1. Удалить старые чанки (если есть)
2. Запустить пайплайн индексации (будет реализован в 4.8)

На этом этапе реализуем только сигналы и "заглушку" для индексации. Полный пайплайн появится позже.

Каскадное удаление (`on_delete=CASCADE`) гарантирует, что при удалении поста все его чанки удаляются автоматически — это уже настроено в 4.3.

**Философия:** Данные должны быть консистентны — нет "осиротевших" чанков.

**Документация:**

- [ИИ поиск на базе смыслов — концепция](../researches/report_6/ИИ%20поиск%20на%20базе%20смыслов%20-%20концепция.md) — "ЭТАП 2: Движок индексации"

---

## Задачи

### Создание сигналов

- [ ] Создать файл `blog/signals.py`
- [ ] Импортировать `post_save`, `post_delete` из `django.db.models.signals`
- [ ] Создать функцию-обработчик `trigger_post_indexing(sender, instance, created, **kwargs)`
- [ ] Декорировать функцию `@receiver(post_save, sender=Post)`

### Логика обработчика

- [ ] Проверить, изменился ли контент поста (сравнить `content` с предыдущим значением)
- [ ] Если контент изменился — пометить пост для переиндексации
- [ ] На этом этапе: просто логировать "Post {id} marked for reindexing"
- [ ] Реальная индексация будет добавлена в фазе 4.8

### Оптимизация: отслеживание изменений

- [ ] Добавить поле `content_hash` в модель `Post` (опционально)
- [ ] Или использовать `django-model-utils` FieldTracker для отслеживания изменений
- [ ] Альтернатива: всегда переиндексировать при сохранении (проще, но дороже)

### Регистрация сигналов

- [ ] В `blog/apps.py` переопределить метод `ready()`
- [ ] Импортировать `blog.signals` в методе `ready()` для активации сигналов

### Валидация каскадного удаления

- [ ] Создать тестовый пост с чанками через shell
- [ ] Удалить пост
- [ ] Проверить, что чанки удалены автоматически

---

## Тестирование

- [ ] Сохранить пост через админку
- [ ] Проверить, что в логах появилось сообщение о переиндексации
- [ ] Сохранить пост без изменения контента — логи не должны появляться (если реализовано отслеживание)

---

## Коммит

```
phase 4.4 feat: Связь Post → TextChunk с сигналами
- Создан файл blog/signals.py с обработчиком post_save
- Настроена регистрация сигналов в apps.py
- Добавлено логирование для отладки индексации
- Проверено каскадное удаление чанков
```
