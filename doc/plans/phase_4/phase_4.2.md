# Фаза 4.2: Настройка pgvector и FTS

## Цель

Активировать расширения PostgreSQL для векторного и полнотекстового поиска.

---

## Контекст

PostgreSQL сам по себе не поддерживает векторные типы данных. Расширение **pgvector** добавляет тип `vector`, индексы HNSW/IVFFlat и операторы расстояния. Версия 0.8.0+ критична для проекта — она поддерживает:

- `halfvec` (FP16) — экономия памяти в 2 раза
- `sparsevec` — разреженные векторы для SPLADE/BM25
- Iterative Index Scans — решение проблемы пост-фильтрации

Расширение **ltree** позволяет моделировать иерархию "Статья → Секция → Чанк" для структурной навигации.

Для русскоязычного контента критична настройка **Full Text Search (FTS)** с русским стеммером/лемматизатором.

**Философия:** Инфраструктура должна быть готова до создания моделей.

**Документация:**

- [Технический отчёт: Chonkie, PostgreSQL, pgvector](../researches/report_6/Технический%20отчет_%20Chonkie,%20Postgresql,%20pgvector.md) — раздел 4 "Векторный движок: pgvector 0.8.0+"
- [Django, pgvector: семантический поиск локально](../researches/report_6/Django,%20pgvector_%20семантический%20поиск%20локально.md) — раздел 3.1-3.2 "Типы данных и стратегии индексации"

---

## Задачи

### Установка расширений в PostgreSQL

- [ ] Подключиться к PostgreSQL: `docker exec -it <container> psql -U <user> -d <db>`
- [ ] Выполнить `CREATE EXTENSION IF NOT EXISTS vector;`
- [ ] Выполнить `CREATE EXTENSION IF NOT EXISTS ltree;`
- [ ] Проверить установку: `SELECT * FROM pg_extension;`

### Альтернатива: расширения через Docker

- [ ] Использовать образ `pgvector/pgvector:pg17` вместо `postgres:17-alpine`
- [ ] Этот образ уже содержит pgvector, нужно только `CREATE EXTENSION`

### Настройка русского FTS

- [ ] Проверить доступные конфигурации: `SELECT cfgname FROM pg_ts_config;`
- [ ] Протестировать русский стеммер: `SELECT to_tsvector('russian', 'настройка базы данных');`
- [ ] При необходимости создать кастомную конфигурацию с hunspell
- [ ] Альтернатива: использовать `pg_trgm` для fuzzy search (триграммы)

### Django-интеграция

- [ ] Установить пакет `pgvector` (Python) через Poetry
- [ ] Проверить, что `VectorField` импортируется: `from pgvector.django import VectorField`
- [ ] Добавить миграцию для активации расширений (операция `CREATE EXTENSION` в миграции)

### Валидация

- [ ] Создать тестовую таблицу с `vector(3)` колонкой через psql
- [ ] Вставить тестовый вектор и выполнить поиск по косинусному расстоянию
- [ ] Удалить тестовую таблицу

---

## Референс

Создание расширения через Django-миграцию:

Операция `migrations.RunSQL` с командой `CREATE EXTENSION IF NOT EXISTS vector;` в методе `operations` миграции. Это гарантирует, что расширение создаётся при первом деплое.

---

## Коммит

```
phase 4.2 feat: Настройка pgvector и FTS
- Переключен образ на pgvector/pgvector:pg17
- Добавлена миграция для CREATE EXTENSION vector, ltree
- Проверена работа русского FTS
- Добавлена зависимость pgvector (Python)
```
