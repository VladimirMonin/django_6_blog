# Фаза 4.12: API поиска (View + URL)

## Цель

Создать Django View для обработки поисковых запросов с поддержкой HTMX.

---

## Контекст

Сервис поиска (фазы 4.9-4.11) готов, теперь нужен HTTP-интерфейс. View должен:

- Принимать GET-параметр `q` с поисковым запросом
- Определять тип запроса: обычный (полная страница) или HTMX (частичный HTML)
- Возвращать соответствующий шаблон

Интеграция с `django-htmx` позволяет легко определить HTMX-запросы через `request.htmx`.

**Паттерн ответа:**

- Обычный запрос → полная страница с формой и результатами
- HTMX-запрос → только блок результатов для вставки в DOM

**Философия:** Один View, два режима — прогрессивное улучшение.

**Документация:**

- [ИИ поиск на базе смыслов — концепция](../researches/report_6/ИИ%20поиск%20на%20базе%20смыслов%20-%20концепция.md) — "UX/UI паттерны (HTMX & Frontend)"

---

## Задачи

### Создание View

- [ ] Добавить в `blog/views.py` функцию `search_view(request)`
- [ ] Или создать класс `SearchView(View)` для расширяемости
- [ ] Получить параметр `q` из `request.GET`
- [ ] Валидировать: минимальная длина запроса (например, 2 символа)

### Логика обработки

- [ ] Если запрос пустой — показать форму поиска без результатов
- [ ] Если есть запрос — вызвать `hybrid_search(query)`
- [ ] Передать результаты в шаблон

### Определение типа запроса

- [ ] Проверить `request.htmx` (атрибут от django-htmx)
- [ ] HTMX-запрос → использовать partial-шаблон `_search_results.html`
- [ ] Обычный запрос → использовать полный шаблон `search.html`

### Создание URL

- [ ] Добавить в `blog/urls.py` маршрут: `path('search/', search_view, name='search')`
- [ ] Или использовать отдельное приложение для поиска

### Создание шаблонов

- [ ] `templates/blog/search.html` — полная страница с формой
- [ ] `templates/blog/_search_results.html` — partial с результатами
- [ ] Форма поиска с `hx-get`, `hx-target`, `hx-trigger="keyup changed delay:300ms"`

### Обработка ошибок

- [ ] Ошибка API (OpenAI недоступен) → показать сообщение пользователю
- [ ] Пустой результат → "Ничего не найдено по запросу..."
- [ ] Слишком короткий запрос → подсказка ввести больше символов

### Пагинация (опционально)

- [ ] Для MVP: показывать топ-10 результатов без пагинации
- [ ] В будущем: добавить "Показать ещё" через HTMX

---

## Тестирование

- [ ] Открыть `/search/` — отображается форма
- [ ] Ввести запрос — результаты появляются
- [ ] Проверить HTMX-режим: результаты обновляются без перезагрузки страницы
- [ ] Проверить fallback: без JavaScript страница работает

---

## Коммит

```
phase 4.12 feat: API поиска (View + URL)
- Добавлен search_view в blog/views.py
- Создан маршрут /search/ в urls.py
- Созданы шаблоны search.html и _search_results.html
- Интеграция с django-htmx для live-поиска
```
