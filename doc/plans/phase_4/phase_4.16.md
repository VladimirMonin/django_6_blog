# Фаза 4.16: Визуализатор чанков

## Цель

Создать инструмент отладки для визуализации результата чанкинга в админке.

---

## Контекст

При разработке системы чанкинга критически важно видеть, как статья разбивается на фрагменты. Проблемы, которые нужно выявлять:
- "Разорванные функции" — код разрезан посередине
- Слишком большие чанки — потеря точности поиска
- Слишком маленькие чанки ("осколки") — потеря контекста
- Неправильная типизация — код помечен как TEXT

**Визуализатор** — это inline-виджет в админке поста, показывающий:
- Все чанки поста в порядке position_index
- Цветовую кодировку по типу
- Размер в токенах
- Предупреждения о проблемах

**Философия:** Отладка через визуализацию, а не логи.

**Документация:**
- [ИИ поиск на базе смыслов — концепция](../researches/report_6/ИИ%20поиск%20на%20базе%20смыслов%20-%20концепция.md) — "ЭТАП 4: Chunk Visualizer"

---

## Задачи

### Inline для чанков

- [ ] В `blog/admin.py` создать `TextChunkInline(admin.TabularInline)`
- [ ] Модель: `TextChunk`
- [ ] Поля: `position_index`, `chunk_type`, `section_title`, `content_preview`, `token_count`
- [ ] `extra = 0` — не показывать пустые формы
- [ ] `readonly_fields` — все поля только для чтения

### Превью контента

- [ ] Метод `content_preview(self, obj)` — первые 100 символов с "..."
- [ ] Для CODE: показать первую строку (сигнатура функции)
- [ ] HTML escape для безопасности

### Подсчёт токенов

- [ ] Метод `token_count(self, obj)` — количество токенов в чанке
- [ ] Использовать tiktoken для подсчёта
- [ ] Кэшировать результат (можно хранить в модели)

### Цветовая кодировка

- [ ] CSS-классы для разных chunk_type
- [ ] TEXT — синий фон
- [ ] CODE — зелёный фон
- [ ] MERMAID_DESC — фиолетовый фон
- [ ] Предупреждения — красная рамка

### Выявление проблем

- [ ] Чанк > 600 токенов — предупреждение "Слишком большой"
- [ ] Чанк < 50 токенов — предупреждение "Слишком маленький"
- [ ] CODE без code_language — предупреждение "Язык не определён"

### Регистрация Inline

- [ ] Добавить `TextChunkInline` в `PostAdmin.inlines`
- [ ] Расположить после основных полей поста

### Кнопка "Manual Override" (опционально)

- [ ] Возможность редактировать чанк вручную
- [ ] Только для суперпользователей
- [ ] С предупреждением о последствиях

---

## Тестирование

- [ ] Открыть пост с чанками в админке
- [ ] Проверить, что все чанки отображаются в inline
- [ ] Проверить цветовую кодировку типов
- [ ] Проверить отображение предупреждений
- [ ] Убедиться, что большие посты не тормозят страницу

---

## Коммит

```
phase 4.16 feat: Визуализатор чанков
- Создан TextChunkInline в PostAdmin
- Добавлены методы content_preview и token_count
- Реализована цветовая кодировка типов
- Добавлены предупреждения о проблемах чанкинга
```
