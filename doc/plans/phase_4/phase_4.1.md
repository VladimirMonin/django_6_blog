# Фаза 4.1: Миграция на PostgreSQL

## Цель

Перевести проект с SQLite на PostgreSQL 17+ для поддержки векторного поиска и расширений.

---

## Контекст

Текущий проект использует SQLite (`db.sqlite3`), который не поддерживает расширение pgvector для хранения и поиска векторов. PostgreSQL — единственная СУБД, позволяющая хранить реляционные данные и векторы в одном месте с ACID-гарантиями.

PostgreSQL 17+ (или 18.1) обеспечивает критические преимущества для RAG-систем:
- Асинхронный I/O (io_uring) — ускорение "холодного" векторного поиска в 2-3 раза
- UUIDv7 — временная упорядоченность данных
- Единая транзакционность для текста и векторов

**Философия:** Консолидация данных — один источник истины вместо зоопарка сервисов.

**Документация:**
- [Технический отчёт: Chonkie, PostgreSQL, pgvector](../researches/report_6/Технический%20отчет_%20Chonkie,%20Postgresql,%20pgvector.md) — раздел 3 "Фундамент данных: PostgreSQL 18.1"
- [Django, pgvector: семантический поиск локально](../researches/report_6/Django,%20pgvector_%20семантический%20поиск%20локально.md) — раздел 3 "PostgreSQL как векторная база данных"

---

## Задачи

### Docker-инфраструктура

- [ ] Создать файл `docker-compose.yml` в корне проекта
- [ ] Настроить сервис PostgreSQL 17 (образ `postgres:17-alpine`)
- [ ] Указать переменные окружения: `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`
- [ ] Пробросить порт 5432 для локального доступа
- [ ] Добавить volume для персистентности данных (`pgdata`)
- [ ] Добавить `docker-compose.yml` в `.gitignore` (содержит credentials) или использовать `.env`

### Настройка Django

- [ ] Установить пакет `psycopg[binary]` через Poetry
- [ ] Изменить `DATABASES` в `config/settings.py` для PostgreSQL
- [ ] Вынести credentials в переменные окружения (`.env`)
- [ ] Убедиться, что `django-environ` или аналог установлен для чтения `.env`

### Миграция данных

- [ ] Экспортировать данные из SQLite: `python manage.py dumpdata --natural-foreign --natural-primary -o backup.json`
- [ ] Запустить PostgreSQL контейнер: `docker-compose up -d`
- [ ] Применить миграции на новой БД: `python manage.py migrate`
- [ ] Импортировать данные: `python manage.py loaddata backup.json`
- [ ] Проверить целостность данных через админку

### Валидация

- [ ] Убедиться, что сайт работает на новой БД (список постов, детальная страница)
- [ ] Проверить работу админки (создание/редактирование постов)
- [ ] Удалить или переименовать `db.sqlite3` (архив)

---

## Коммит

```
phase 4.1 feat: Миграция на PostgreSQL 17
- Добавлен docker-compose.yml для PostgreSQL
- Изменена конфигурация DATABASES в settings.py
- Данные мигрированы через dumpdata/loaddata
- Добавлена зависимость psycopg[binary]
```
