# Фаза 4.5: Сервис извлечения структуры

## Цель

Создать сервис для парсинга Markdown и выделения структурных элементов (секции, код, текст).

---

## Контекст

Перед чанкингом необходимо понять структуру документа. Markdown-статья состоит из:

- **Секций** (разделённых заголовками H2/H3)
- **Блоков кода** (огороженных тройными апострофами)
- **Текстовых блоков** (абзацы, списки)
- **Таблиц** и **диаграмм Mermaid**

Структурный парсер должен:

1. Разбить документ на секции по заголовкам H2
2. Внутри каждой секции выделить потоки CODE и TEXT
3. Сохранить метаданные: заголовок секции, язык кода, позицию

В проекте уже есть `blog/services/html_processor.py` и процессоры в `blog/services/processors/`. Их можно частично переиспользовать или взять как референс.

**Философия:** Структура важнее контента — сначала понимаем "где", потом "что".

**Документация:**

- [ИИ поиск на базе смыслов — концепция](../researches/report_6/ИИ%20поиск%20на%20базе%20смыслов%20-%20концепция.md) — "ШАГ A: Структурный Парсинг"
- [Технический отчёт: Chonkie, PostgreSQL, pgvector](../researches/report_6/Технический%20отчет_%20Chonkie,%20Postgresql,%20pgvector.md) — раздел 2.2 "Стратегии чанкинга для полиглотичного контента"

---

## Задачи

### Создание сервиса

- [ ] Создать файл `blog/services/structure_extractor.py`
- [ ] Определить функцию `extract_sections(markdown_text: str) -> list[Section]`
- [ ] Создать dataclass `Section` с полями: `title`, `level` (H2/H3), `content_blocks`
- [ ] Создать dataclass `ContentBlock` с полями: `content`, `block_type` (CODE/TEXT), `language` (для кода)

### Логика парсинга

- [ ] Использовать регулярные выражения для поиска заголовков `^#{2,3}\s+(.+)$`
- [ ] Разбить документ на секции по найденным заголовкам
- [ ] Внутри секции искать блоки кода: тройные апострофы с языком
- [ ] Всё остальное — текстовые блоки
- [ ] Сохранять порядок блоков для `position_index`

### Обработка блоков кода

- [ ] Извлекать язык программирования из первой строки блока (```python)
- [ ] Поддержать случай без указания языка (```без тега)
- [ ] Сохранять содержимое кода без маркеров апострофов

### Обработка специальных блоков

- [ ] Детектировать Mermaid-диаграммы (```mermaid)
- [ ] Детектировать таблицы (строки с `|`)
- [ ] Помечать соответствующим типом для дальнейшей обработки

### Интеграция с существующим кодом

- [ ] Изучить `blog/services/markdown_processor.py` для референса
- [ ] При необходимости переиспользовать логику из `code_processor.py`

---

## Тестирование

- [ ] Подготовить тестовый Markdown с заголовками, кодом и текстом
- [ ] Вызвать `extract_sections()` и проверить структуру результата
- [ ] Убедиться, что блоки кода сохраняют язык и содержимое
- [ ] Проверить корректность позиций блоков

---

## Коммит

```
phase 4.5 feat: Сервис извлечения структуры
- Создан blog/services/structure_extractor.py
- Реализована функция extract_sections() для парсинга Markdown
- Добавлены dataclasses Section и ContentBlock
- Поддержка CODE, TEXT, MERMAID блоков
```
