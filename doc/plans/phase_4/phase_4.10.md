# Фаза 4.10: Лексический поиск (FTS)

## Цель

Реализовать полнотекстовый поиск через PostgreSQL Full Text Search.

---

## Контекст

Семантический поиск отлично находит концепции, но плохо справляется с точными терминами: названиями функций, кодами ошибок, специфическими аббревиатурами. Векторная модель может "размыть" точное совпадение.

**PostgreSQL FTS** решает эту проблему:

- Лемматизация: "настройка" → "настраива" (находит "настроить", "настройки")
- Точное совпадение технических терминов
- Ранжирование по tf-idf подобному алгоритму

Для гибридного поиска (фаза 4.11) нужны оба метода: семантический для смысла, лексический для точности.

**Компоненты FTS:**

- `tsvector` — индексируемое представление текста
- `tsquery` — поисковый запрос
- `ts_rank` — функция ранжирования
- `plainto_tsquery` / `websearch_to_tsquery` — парсинг пользовательского ввода

**Философия:** Когда пользователь ищет `DATABASES`, он хочет найти именно `DATABASES`.

**Документация:**

- [Технический отчёт: Chonkie, PostgreSQL, pgvector](../researches/report_6/Технический%20отчет_%20Chonkie,%20Postgresql,%20pgvector.md) — раздел 4.1 "Революция разреженных векторов"
- [ИИ поиск на базе смыслов — концепция](../researches/report_6/ИИ%20поиск%20на%20базе%20смыслов%20-%20концепция.md) — "ЭТАП 3: Поисковый движок"

---

## Задачи

### Настройка search_vector

- [ ] Убедиться, что поле `search_vector` (SearchVectorField) существует в модели TextChunk
- [ ] Создать триггер PostgreSQL для автообновления search_vector при изменении content
- [ ] Или обновлять в коде Django при сохранении чанка

### Создание GIN-индекса

- [ ] Добавить GIN-индекс на поле `search_vector` в миграции
- [ ] GIN (Generalized Inverted Index) оптимален для FTS

### Функция лексического поиска

- [ ] Добавить в `blog/services/search_service.py` функцию `lexical_search(query: str, limit: int = 10) -> list[SearchResult]`
- [ ] Использовать `plainto_tsquery('russian', query)` для парсинга запроса
- [ ] Фильтровать чанки: `search_vector @@ query`
- [ ] Ранжировать через `ts_rank(search_vector, query)`

### Обработка русского языка

- [ ] Использовать конфигурацию `russian` для tsvector и tsquery
- [ ] Протестировать лемматизацию на примерах
- [ ] При необходимости настроить hunspell словарь

### Обработка технических терминов

- [ ] Технические термины (CamelCase, snake_case) плохо лемматизируются
- [ ] Рассмотреть добавление `pg_trgm` для fuzzy-поиска по триграммам
- [ ] Или: сохранять оригинальные термины в отдельном поле

### Формирование ответа

- [ ] Вернуть список `SearchResult` с теми же полями, что и семантический поиск
- [ ] Добавить поле `rank` из ts_rank для сравнения
- [ ] Нормализовать score для совместимости с RRF

---

## Тестирование

- [ ] Поискать точный технический термин (например, "Django")
- [ ] Проверить, что лемматизация работает ("настройка" находит "настроить")
- [ ] Сравнить результаты с семантическим поиском
- [ ] Убедиться, что GIN-индекс используется (EXPLAIN ANALYZE)

---

## Коммит

```
phase 4.10 feat: Лексический поиск (FTS)
- Добавлена функция lexical_search в search_service.py
- Настроен GIN-индекс на search_vector
- Реализовано автообновление search_vector
- Поддержка русского языка через конфигурацию 'russian'
```
